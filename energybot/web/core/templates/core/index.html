{% load static %} {% load time_filters %}

<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <title>EnergyBot Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: #f6f7fb;
        font-family: "Inter", sans-serif;
      }
      .card {
        border: none;
        border-radius: 1rem;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      }
      .queue-grid {
        display: grid;
        grid-template-columns: repeat(24, 1fr);
        gap: 2px;
      }
      .slot {
        text-align: center;
        padding: 5px;
        font-size: 0.8rem;
        border-radius: 4px;
      }
      .prev-slot {
        opacity: 0.5;
      }
      .on {
        background: #e2f7da;
      }
      .off {
        background: #fad9d9;
      }
      .wait {
        background: #fcfad2;
      }
      .unknown {
        background: #dfcece;
      }
      .console {
        background: #1d1b1b;
        color: #0f0;
        font-family: monospace;
        height: 400px;
        overflow-y: auto;
        border-radius: 8px;
        padding: 10px;
      }
    </style>
  </head>
  <body style="padding-top: 90px">
    <div class="container">
      <div
        class="container position-fixed top-0 start-0 end-0 bg-white shadow-sm py-3 px-4 d-flex justify-content-between align-items-center mb-4"
        style="z-index: 1030"
      >
        <h1 class="fw-bold m-0">âš¡ EnergyBot Dashboard</h1>
        <a href="/admin/" class="btn btn-dark">Admin Panel</a>
      </div>
      <!-- Stats -->
      <div class="row g-3 mb-4">
        <div class="col-md-4">
          <div class="card p-3 text-center">
            <h5>ðŸ‘¥ Total Users</h5>
            <h2>{{ total_users }}</h2>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card p-3 text-center">
            <h5>ðŸ”¢ Queues</h5>
            <h2>{{ total_queues }}</h2>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card p-3 text-center">
            <h5>ðŸ“¬ Subscriptions</h5>
            <h2>{{ total_subs }}</h2>
          </div>
        </div>
      </div>

      <!-- Live logs -->
      <h4 class="mt-5 mb-3">ðŸ§¾ Live Logs</h4>
      <pre id="log-console" class="console"></pre>

      <!-- Queue States -->
      <h4 class="mt-5 mb-3">ðŸ•“ Current Queues</h4>
      <div class="row g-3">
        {% for q in queues %}
        <div class="col-md-12">
          <div class="card p-3">
            <h5>{{ q.name }}</h5>
            <div class="queue-grid mt-2">
              {% for s in q.current_state %}
              <div
                class="slot {% if s.state == 'ON' %}on{% elif s.state == 'OFF' %}off{% elif s.state == 'WAIT' %}wait{% else %}unknown{% endif %}"
              >
                {{ s.start_time_min|minutes_to_time }}
              </div>
              {% endfor %}
            </div>
            <div class="queue-grid mt-2">
              {% for s in q.prev_state %}
              <div
                class="prev-slot slot {% if s.state == 'ON' %}on{% elif s.state == 'OFF' %}off{% elif s.state == 'WAIT' %}wait{% else %}unknown{% endif %}"
              >
                {{ s.start_time_min|minutes_to_time }}
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
        {% empty %}
        <p>No queue data available.</p>
        {% endfor %}
      </div>
    </div>

    <script>
      // Simple auto-refresh log (every 2s)
      async function fetchLogs() {
        const res = await fetch("/logs/");
        if (res.ok) {
          const text = await res.text();
          document.getElementById("log-console").textContent = text;
          const el = document.getElementById("log-console");
          el.scrollTop = el.scrollHeight;
        }
      }
      setInterval(fetchLogs, 2000);
      fetchLogs();
    </script>
  </body>
</html>
